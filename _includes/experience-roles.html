{% assign experience_path_parts = page.path | split: '/' %}
{% assign experience_filename = experience_path_parts | last | split: '.' | first %}
{% assign matched_roles = "" | split: "" %}
{% for role in site.roles %}
  {% assign role_path_parts = role.path | split: '/' %}
  {% if role_path_parts.size > 2 %}
    {% assign role_directory = role_path_parts[1] %}
    {% if role_directory == experience_filename %}
      {% assign matched_roles = matched_roles | push: role %}
    {% endif %}
  {% endif %}
{% endfor %}

{% assign sorted_roles = "" | split: "" %}
{% for i in (0..999) %}
  {% assign found_role = null %}
  {% assign latest_date = null %}
  {% for role in matched_roles %}
    {% assign already_sorted = false %}
    {% for sorted_role in sorted_roles %}
      {% if sorted_role.path == role.path %}
        {% assign already_sorted = true %}
        {% break %}
      {% endif %}
    {% endfor %}
    {% unless already_sorted %}
      {% if role.start_date %}
        {% assign role_date_epoch = role.start_date | date: "%s" | plus: 0 %}
        {% if latest_date == null or role_date_epoch > latest_date %}
          {% assign latest_date = role_date_epoch %}
          {% assign found_role = role %}
        {% endif %}
      {% else %}
        {% if latest_date == null %}
          {% assign found_role = role %}
        {% endif %}
      {% endif %}
    {% endunless %}
  {% endfor %}
  {% if found_role %}
    {% assign sorted_roles = sorted_roles | push: found_role %}
  {% else %}
    {% break %}
  {% endif %}
{% endfor %}

{% for role in sorted_roles %}
{% if sorted_roles.size > 1 %}
{% include date-range.html start_date=role.start_date end_date=role.end_date %}
{% endif %}
<h2>{{ role.title }}</h2>

{{ role.content | markdownify }}
{% endfor %}

